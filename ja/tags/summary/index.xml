<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Summary on 向叔の手帳</title>
        <link>https://ttf248.life/ja/tags/summary/</link>
        <description>Recent content in Summary on 向叔の手帳</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>ja</language>
        <lastBuildDate>Wed, 04 Jun 2025 19:21:00 +0800</lastBuildDate><atom:link href="https://ttf248.life/ja/tags/summary/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>Prometheus監視システムにおけるヒストグラムとサマリー</title>
        <link>https://ttf248.life/ja/p/prometheus-monitoring-system-histogram-and-summary/</link>
        <pubDate>Wed, 04 Jun 2025 19:00:28 +0800</pubDate>
        
        <guid>https://ttf248.life/ja/p/prometheus-monitoring-system-histogram-and-summary/</guid>
        <description>&lt;p&gt;ビジネスシステムは、要約タイプの監視指標を設計し、平均処理時間（request_duration_milliseconds_sum / request_duration_milliseconds_count）を計算していました。&lt;/p&gt;
&lt;p&gt;データを確認したところ、あるインターフェースの平均処理時間が非常に高くなっていることが判明しました。時系列グラフを見ると、平均処理時間が突然増加しており、それは単一のリクエストの処理時間が長かったために引き起こされたもので、平均値を押し上げている状態でした。具体的にいつ発生したリクエストを特定したいのですが、その期間内のリクエスト数が少なく、結果データが常に空になってしまいます。&lt;/p&gt;
&lt;h3 id=&#34;-なぜ-_sum-と-_count-にデータがあるのか&#34;&gt;✅ なぜ &lt;code&gt;_sum&lt;/code&gt; と &lt;code&gt;_count&lt;/code&gt; にデータがあるのか
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;_sum&lt;/code&gt; と &lt;code&gt;_count&lt;/code&gt; は Summary 型の&lt;strong&gt;コア指標&lt;/strong&gt;であり、Prometheus は常にこれらの値を収集して記録します。&lt;/li&gt;
&lt;li&gt;どちらも&lt;strong&gt;累積型のカウンター&lt;/strong&gt;であるため、&lt;code&gt;rate()&lt;/code&gt; または &lt;code&gt;increase()&lt;/code&gt; を使用するのに適しています。&lt;/li&gt;
&lt;li&gt;リクエスト遅延がどのように変化しても、リクエストが存在すれば必ず &lt;code&gt;_sum&lt;/code&gt; と &lt;code&gt;_count&lt;/code&gt; のデータがあります。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;-quantile099-が時系列グラフで表示されない理由&#34;&gt;❌ &lt;code&gt;{quantile=&amp;quot;0.99&amp;quot;}&lt;/code&gt; が時系列グラフで表示されない理由
&lt;/h3&gt;&lt;p&gt;Summary にも quantile=&amp;ldquo;0.99&amp;rdquo; を設定していても、この時間系列が存在しないか欠損している可能性があります：
指標は確実に設定されており、データが期限切れでもありません。📉 リクエスト数が少ないため、quantile を計算できません。スライディングウィンドウメカニズムにより、この期間を過ぎると統計範囲に再含まれなくなります。
分位数（例えば p99）はサンプリング統計によって計算されます：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1～2 件程度のリクエストしかない期間では、p99 の計算が&lt;strong&gt;不安定または代表的ではありません&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;Prometheus &lt;strong&gt;クライアント SDK は、この quantile 時間系列を公開しないように選択します&lt;/strong&gt;（誤解を避けるため）。&lt;/li&gt;
&lt;li&gt;その結果、&lt;code&gt;_sum&lt;/code&gt;、&lt;code&gt;_count&lt;/code&gt; が正常に累積されますが、&lt;code&gt;quantile=&amp;quot;0.99&amp;quot;&lt;/code&gt; にデータが表示されません。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;ヒストグラムとサマリーの違い&#34;&gt;ヒストグラムとサマリーの違い
&lt;/h3&gt;&lt;h4 id=&#34;1-ヒストグラム&#34;&gt;1. &lt;strong&gt;ヒストグラム&lt;/strong&gt;
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;仕組み:&lt;/strong&gt; ヒストグラムはデータをビン（バケット）に分割し、各ビンに該当するサンプル数（データ数）を記録します。
例として、&lt;code&gt;[10ms, 50ms, 100ms, 500ms, 1s]&lt;/code&gt; の範囲でビンを設定した場合、各リクエストのレイテンシ（遅延時間）は対応するビンに割り当てられます。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;利点:&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;Prometheus で複数のインスタンス（例えば、複数のサービスノードのリクエストレイテンシ分布）からデータを集計できます。&lt;/li&gt;
&lt;li&gt;分位数（P50、P95、P99 など）を計算し、レイテンシの分布を観察するのに適しています。&lt;/li&gt;
&lt;li&gt;PromQL を使用して動的に分位数を計算するための柔軟なクエリ機能を提供します。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;欠点:&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;ビンの範囲を事前に定義する必要があり、選択が不適切だとデータ分布が偏る可能性があります（例えば、すべてのリクエストが 1 つのビンに集中する）。&lt;/li&gt;
&lt;li&gt;ビンの数が多いほど、ストレージと計算のオーバーヘッドが増加します。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;適用シナリオ:&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;複数のインスタンスからデータを集計する必要がある場合。&lt;/li&gt;
&lt;li&gt;分位数を動的に調整したり、レイテンシ分布を分析したりする場合。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;2-概要&#34;&gt;2. &lt;strong&gt;概要&lt;/strong&gt;
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;仕組み:&lt;/strong&gt; Summary はクライアント側でパーセンタイル（P50、P95、P99 など）を直接計算し、その結果を Prometheus に報告します。
また、サンプル全体の数と合計も記録し、平均値を計算するために使用します。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;利点:&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;バケットを事前に定義する必要がなく、パーセンタイル結果を直接提供します。&lt;/li&gt;
&lt;li&gt;単一インスタンスでの正確なパーセンタイル計算に適しています。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;欠点:&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;パーセンタイルの計算はクライアント側で行われるため、Prometheus で複数のインスタンスのデータを集計できません。&lt;/li&gt;
&lt;li&gt;パーセンタイルを変更（例：P95 から P99 に）するには、コードを修正して再デプロイする必要があります。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;適用シナリオ:&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;単一インスタンスでの監視であり、パーセンタイルに対する正確性が高い場合。&lt;/li&gt;
&lt;li&gt;複数のインスタンスのデータを集計する必要がない場合。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;3-主な違いの比較&#34;&gt;3. &lt;strong&gt;主な違いの比較&lt;/strong&gt;
&lt;/h4&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;特性&lt;/th&gt;
&lt;th&gt;ヒストグラム&lt;/th&gt;
&lt;th&gt;サマリー&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;分位数の計算&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Prometheus内で動的に計算&lt;/td&gt;
&lt;td&gt;クライアントで直接計算&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&#34;3-主な違いの比較-1&#34;&gt;3. &lt;strong&gt;主な違いの比較&lt;/strong&gt;
&lt;/h4&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;特性&lt;/th&gt;
&lt;th&gt;ヒストグラム&lt;/th&gt;
&lt;th&gt;サマリー&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;複数インスタンスアグリゲーション&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;対応&lt;/td&gt;
&lt;td&gt;非対応&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&#34;3-主な違いの比較-2&#34;&gt;3. &lt;strong&gt;主な違いの比較&lt;/strong&gt;
&lt;/h4&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;特性&lt;/th&gt;
&lt;th&gt;ヒストグラム&lt;/th&gt;
&lt;th&gt;サマリー&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ビンの定義&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;事前に定義する必要がある&lt;/td&gt;
&lt;td&gt;不要&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&#34;3-主な違いの比較-3&#34;&gt;3. &lt;strong&gt;主な違いの比較&lt;/strong&gt;
&lt;/h4&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;特性&lt;/th&gt;
&lt;th&gt;ヒストグラム&lt;/th&gt;
&lt;th&gt;サマリー&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ストレージコスト&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;バーンの数に依存&lt;/td&gt;
&lt;td&gt;固定コスト&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&#34;3-主な違いの比較-4&#34;&gt;3. &lt;strong&gt;主な違いの比較&lt;/strong&gt;
&lt;/h4&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;特性&lt;/th&gt;
&lt;th&gt;ヒストグラム&lt;/th&gt;
&lt;th&gt;サマリー&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;柔軟性&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;高 (動的にビン数を調整可能)&lt;/td&gt;
&lt;td&gt;低 (コードを修正してビン数を調整する必要あり)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&#34;3-主な違いの比較-5&#34;&gt;3. &lt;strong&gt;主な違いの比較&lt;/strong&gt;
&lt;/h4&gt;&lt;hr&gt;
&lt;h4 id=&#34;4-まとめ&#34;&gt;4. &lt;strong&gt;まとめ&lt;/strong&gt;
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;複数のインスタンスのデータを集約したり、分位数を柔軟に調整する必要がある場合は、&lt;strong&gt;ヒストグラム&lt;/strong&gt;を選択してください。&lt;/li&gt;
&lt;li&gt;単一インスタンスの正確な分位数が必要で、分位数が固定されている場合は、&lt;strong&gt;サマリー&lt;/strong&gt;を選択してください。&lt;/li&gt;
&lt;li&gt;あなたのシナリオでは、サービスが分散しているため、Prometheus ですべてのインスタンスのデータを集約し、動的に分位数と経過時間分布を計算するために、&lt;strong&gt;ヒストグラム&lt;/strong&gt;を使用することを優先することをお勧めします。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;スライディングウィンドウの概念とそのヒストグラムおよびサマリーとの関係&#34;&gt;スライディングウィンドウの概念とそのヒストグラムおよびサマリーとの関係
&lt;/h3&gt;&lt;h4 id=&#34;1-スライディングウィンドウの概念&#34;&gt;1. &lt;strong&gt;スライディングウィンドウの概念&lt;/strong&gt;
&lt;/h4&gt;&lt;p&gt;スライディングウィンドウは、時間ウィンドウメカニズムであり、一定期間内のデータ変化を統計するために使用されます。それは、不断移動する時間範囲を通して、システムのリアルタイム状態を動的に反映します。スライディングウィンドウの特徴は以下のとおりです：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;固定された時間範囲&lt;/strong&gt;: ウィンドウの長さは固定されており、例えば最近1分、5分などがあります。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;リアルタイム更新&lt;/strong&gt;: 時間経過とともに、ウィンドウがスライドし、古いデータがウィンドウから削除され、新しいデータがウィンドウに追加されます。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;一般的な用途&lt;/strong&gt;: リアルタイム指標（リクエストレート、平均値、パーセンタイルなど）を計算するために使用されます。
Prometheusでは、スライディングウィンドウは通常、クエリ関数（&lt;code&gt;rate()&lt;/code&gt;、&lt;code&gt;avg_over_time()&lt;/code&gt;など）によって実装されます。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;2-スライディングウィンドウとヒストグラムの関係&#34;&gt;2. &lt;strong&gt;スライディングウィンドウとヒストグラムの関係&lt;/strong&gt;
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ヒストグラムのデータ構造&lt;/strong&gt;: &lt;br&gt;
ヒストグラムは、サンプルデータをビンに分割し、各ビンのカウントを記録します。Prometheus は周期的にこれらのカウント値を収集します。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;スライディングウィンドウの実装&lt;/strong&gt;: &lt;br&gt;
Prometheus では、クエリ文を使用してヒストグラムのデータに対してスライディングウィンドウを適用できます。例えば：
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;rate(http_request_duration_seconds_bucket[5m])&lt;/code&gt;: 過去 5 分間の各ビンのリクエストレートを計算します。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))&lt;/code&gt;: 過去 5 分間の P95 分位数を計算します。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;利点&lt;/strong&gt;:
&lt;ul&gt;
&lt;li&gt;スライディングウィンドウは、最近の時間の要求時間分布を動的に反映できます。&lt;/li&gt;
&lt;li&gt;ヒストグラムのビニングメカニズムとスライディングウィンドウを組み合わせることで、効率的に分位数や分布を計算できます。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;3-summary-とサマリーの関係&#34;&gt;3. &lt;strong&gt;Summary とサマリーの関係&lt;/strong&gt;
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;サマリーのデータ構造&lt;/strong&gt;:
サマリーはクライアント側でパーセンタイルを直接計算し、Prometheus へ送信します。また、サンプル総数と合計も記録します。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;スライディングウィンドウの実装&lt;/strong&gt;:
Prometheus では、クエリ文を使用してサマリーのデータをスライディングウィンドウに適用できます。例えば：
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])&lt;/code&gt;: 過去 5 分間の平均リクエスト時間計算します。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;制限&lt;/strong&gt;:
&lt;ul&gt;
&lt;li&gt;サマリーのパーセンタイルはクライアント側で計算されるため、Prometheus で再計算できません。したがって、スライディングウィンドウによるパーセンタイルのサポートは限られています。&lt;/li&gt;
&lt;li&gt;複数のインスタンスのデータを集計する必要がある場合、スライディングウィンドウはサマリーのパーセンタイルに直接作用しません。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;4-スライディングウィンドウの適用場面&#34;&gt;4. &lt;strong&gt;スライディングウィンドウの適用場面&lt;/strong&gt;
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;リアルタイム監視&lt;/strong&gt;: スライディングウィンドウは、システムのリアルタイムな状態を監視するのに適しています。例えば、最近1分間のリクエストレートやレイテンシ分布などです。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;異常検知&lt;/strong&gt;: スライディングウィンドウを使用することで、短期間での異常事象（例えば、リクエストのレイテンシが急増するなど）を迅速に検出できます。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;動的分析&lt;/strong&gt;: スライディングウィンドウは、システムの変化傾向を動的に反映し、静的なグローバル統計とは異なります。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;5-まとめ&#34;&gt;5. &lt;strong&gt;まとめ&lt;/strong&gt;
&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ヒストグラム&lt;/strong&gt; とスライディングウィンドウを組み合わせることで、分位数（例：P95、P99）とリクエストの経過時間分布を動的に計算でき、分散システムでの監視に適しています。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;サマリー&lt;/strong&gt; はスライディングウィンドウと組み合わせて平均値などの単純な指標を計算できますが、分位数の柔軟性に欠け、多インスタンスアグリゲーションもサポートしていません。
あなたのシナリオでは、極端なリクエストの経過時間（例：P99）と大部分のリクエストの平均値を監視する必要があるため、&lt;strong&gt;ヒストグラム&lt;/strong&gt; を使用し、スライディングウィンドウを組み合わせてシステムのパフォーマンスを動的に分析することをお勧めします。&lt;/li&gt;
&lt;/ul&gt;
</description>
        </item>
        
    </channel>
</rss>
